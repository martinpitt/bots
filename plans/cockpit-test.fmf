summary: Run cockpit test
prepare:
    how: install
    package:
      - podman

discover:
    how: fmf
execute:
    how: tmt

/run:
    summary: Run test in tasks container
    environment:
        TEST_OS:
        TEST_SCENARIO:
    test: |
        set -ex
        # get hw info
        ls -l /dev/kvm
        lscpu
        free -t -h

        podman run --rm \
            --device /dev/kvm \
            --shm-size=256m \
            --ulimit core=-1 \
            -e GIT_URL="$GIT_URL" \
            -e GIT_REF="$GIT_REF" \
            -e TEST_OS="$TEST_OS" \
            -e TEST_SCENARIO="$TEST_SCENARIO" \
            ghcr.io/cockpit-project/tasks \
            sh -exc "
                git clone https://github.com/cockpit-project/cockpit-files
                cd cockpit-files
                time make prepare-check
                time make check
            "
    duration: 60m
