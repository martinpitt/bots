name: RHEL Image Build on Testing Farm
on:
  pull_request:

jobs:
  test-rhel-setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write
    steps:
      - name: Clone repository
        uses: actions/checkout@v5

      - name: Schedule tests on Testing Farm
        id: testing_farm
        uses: sclorg/testing-farm-as-github-action@v2
        with:
          api_key: ${{ secrets.TESTING_FARM_API_KEY }}
          # https://api.testing-farm.io/v0.1/composes/redhat
          compose: Fedora-43-Updated
          # Specify git repository and ref for PR head
          git_url: ${{ github.event.pull_request.head.repo.clone_url }}
          git_ref: ${{ github.event.pull_request.head.ref }}
          # Request virtualized guest with KVM support
          # https://tmt.readthedocs.io/en/stable/spec/hardware.html#virtualization
          tmt_hardware: '{"virtualization": {"is-virtualized": true, "is-supported": true}}'
          # Pass secrets to the test environment (semicolon-separated)
          secrets: TEST_SECRET=${{ secrets.TEST_SECRET }}
          # Use our tmt plan
          tmt_plan_regex: rhel-image-build
          # Increase timeout for image building (once we do actual builds)
          timeout: 120

      - name: Comment on PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const requestId = '${{ steps.testing_farm.outputs.request_id }}';
            const requestUrl = '${{ steps.testing_farm.outputs.request_url }}';
            const testLogUrl = '${{ steps.testing_farm.outputs.test_log_url }}';
            const artifactsUrl = `https://artifacts.osci.redhat.com/testing-farm/${requestId}/`;

            const body = `âœ… Testing Farm test completed successfully!

            **Verified:**
            - Virtualization support (/dev/kvm available)
            - Secret passing works correctly

            **Links:**
            - [Testing Farm Request](${requestUrl})
            - [Test Logs](${testLogUrl})
            - [Artifacts](${artifactsUrl})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
