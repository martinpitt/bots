name: TF image build run
on:
  pull_request:

jobs:
  test-rhel-setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write
    steps:
      - name: Schedule tests on Testing Farm
        id: testing_farm
        uses: sclorg/testing-farm-as-github-action@v2
        with:
          api_key: ${{ secrets.TESTING_FARM_API_KEY }}
          # https://api.testing-farm.io/v0.1/composes/redhat
          compose: Fedora-43-Updated
          # Specify git repository and ref for PR head
          git_url: ${{ github.event.pull_request.head.repo.clone_url }}
          git_ref: ${{ github.event.pull_request.head.ref }}
          # Request virtualized guest with KVM support
          # https://tmt.readthedocs.io/en/stable/spec/hardware.html#virtualization
          tmt_hardware: '{"virtualization": {"is-virtualized": true, "is-supported": true}}'
          # Pass secrets to the test environment (semicolon-separated)
          secrets: TEST_SECRET=${{ secrets.TEST_SECRET }}
          # Pass git info for cloning inside container
          variables: GIT_URL=${{ github.event.pull_request.head.repo.clone_url }};GIT_REF=${{ github.event.pull_request.head.ref }}
          # Use our tmt plan
          tmt_plan_regex: rhel-image-build
          # Increase timeout for image building (once we do actual builds)
          timeout: 120

      - name: Post status with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ steps.testing_farm.conclusion }}' === 'success';
            const state = success ? 'success' : 'failure';
            const description = success ? 'RHEL image build completed' : 'RHEL image build failed';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.pull_request.head.sha }}',
              state: state,
              target_url: `https://artifacts.osci.redhat.com/testing-farm/${{ steps.testing_farm.outputs.request_id }}/`,
              description: description,
              context: 'RHEL Image Build logs'
            });
